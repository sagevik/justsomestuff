#!/bin/sh

# create, mount and use encrypted containers


# Create an empty file to hold encrypted volume
# fallocate -l 1G ~/secure_container.img
# or use dd if fallocate isn't available:
# dd if=/dev/zero of=~/secure_container.img bs=1M count=1024


# format file with LUKS encryption
# sudo cryptsetup luksFormat ~/secure_container.img

# open the encrypted container
# sudo cryptsetup luksOpen ~/secure_container.img secure_container

# format the file with a filesystem
# sudo mkfs.ext4 /dev/mapper/secure_container

# mount the file as a volume
# mkdir ~/secure_mount
# sudo mount /dev/mapper/secure_container ~/secure_mount

#  copy files to ~/secure_mount

# unmount and close
# sudo umount ~/secure_mount
# sudo cryptsetup luksClose secure_container

font="Hack Bold 16"

MOUNT_POINT="$HOME/secure"
ENCRYPTED_IMAGES_DIR="$HOME/dox/encrypted"
ENCRYPTED_IMAGE="secure_container.img"
MAPPED_IMAGE="secure_container"

create_encrypted_image() {
  echo "fallocate -l 1G $ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE"
  fallocate -l 1G "$ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE"
  sleep 2
  echo "sudo cryptsetup luksFormat $ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE"
  sudo cryptsetup luksFormat "$ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE"
  sleep 2
  echo "sudo cryptsetup luksOpen $ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE $ENCRYPTED_IMAGE"
  sudo cryptsetup luksOpen "$ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE $ENCRYPTED_IMAGE"
  sleep 2
  echo "sudo mkfs.ext4 $ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE"
  sudo mkfs.ext4 "$ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE"
  sleep 2
  echo "sudo cryptsetup luksClose $ENCRYPTED_IMAGE"
  sudo cryptsetup luksClose "$ENCRYPTED_IMAGE"
  sleep 2
}

open_encrypted_image() {
  sudo cryptsetup luksOpen "$ENCRYPTED_IMAGES_DIR/$ENCRYPTED_IMAGE" "$MAPPED_IMAGE"
  sudo mount "/dev/mapper/$MAPPED_IMAGE" "$MOUNT_POINT"
}

option=$(echo -e "Create\nOpen\nClose" | fzf)

case $option in
  "Create")
    echo "Create encrypted image"
    create_encrypted_image
    ;;
  "Open")
    echo "Open encrypted image"
    open_encrypted_image
    ;;
  "Close")
    echo "Close encrypted image"
    sudo umount ~/secure
    sudo cryptsetup luksClose secure_container
    ;;
esac
