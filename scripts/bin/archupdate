#!/bin/sh

# Update script for arch
# This script can be used to check for and install package updates on an arch based system.
# It will create a timeshift snapshot before package installation, so timeshift must be
# installed.
#
# Usage:
# $ add script location to path and run: 'archupdate' from commandline
# archupdate will run the script manually to check and list available updates and
# prompt for installing updates yes or no

# Color codes
GREEN="\033[0;32m"
RED="\033[0;31m"
RESET="\033[0m"

MAX_SNAPSHOTS=10

check_for_updates() {
    # Check pacman updates
    pacman_updates=$(checkupdates 2>/dev/null)
    pacman_count=$(echo "$pacman_updates" | grep -v '^$' | wc -l)

    # Check AUR updates using yay
    aur_updates=$(yay -Qua 2>/dev/null)
    aur_count=$(echo "$aur_updates" | grep -v '^$' | wc -l)

    # Output updates if any
    if [ -n "$pacman_updates" ]; then
        echo "Pacman updates:"
        echo "$pacman_updates"
        echo
    fi
    if [ -n "$aur_updates" ]; then
        echo "AUR updates:"
        echo "$aur_updates"
    fi

    # Return total count for use in other functions
    echo $((pacman_count + aur_count))
}

count_snapshots() {
  sudo timeshift --list-snapshots | sed '1,/^------/d' | sed '/^$/d' | wc -l
}

create_snapshot() {
  COMMENT="$1"
  if [ -z "$COMMENT" ]; then
    sudo timeshift --create
  else
    sudo timeshift --create --comments "$COMMENT"
  fi
}

delete_all_snapshots() {
  sudo timeshift --delete-all
}

check_snapshots() {
  if [ "$(count_snapshots)" -gt "$MAX_SNAPSHOTS" ]; then
    notify-send "Snapshots" "Deleting all snapshots\nand creating new base snapshot"
    delete_all_snapshots
    create_snapshot "base snapshot"
  else
    create_snapshot
  fi
}

update_statusbar() {
  pkill -RTMIN+8 waybar
}

total_updates=$(check_for_updates)
update_count=$(echo "$total_updates" | tail -n 1)

if [ "$update_count" -eq 0 ]; then
    echo "No updates available"
    notify-send "archupdate" "No updates available"
    exit 0
else
    echo -e "${GREEN}The following updates are available:${RESET}"
    echo "$total_updates" | head -n -1 # Display all but the last line (count)

    # Prompt for confirmation
    echo
    echo -e "${RED}Do you want to install these updates? (y/n):${RESET}"
    read -r choice

    if [ "$choice" = "y" ] || [ "$choice" = "Y" ]; then
        echo "Updating system"

        # If more than MAX_SNAPSHOTS, delete snapshots and create a new base snapshot
        check_snapshots

        # Create backup
        if ! sudo timeshift --create; then
            echo "Error: Snapshot creation failed"
            notify-send "archupdate" "Snapshot creation failed"
            exit 1
        fi

        # Update packages (pacman and AUR) using yay
        if ! yay -Syu; then
            echo "Error: Package update failed"
            notify-send "archupdate" "Package update failed"
            exit 1
        fi

        # Update GRUB
        if ! sudo grub-mkconfig -o /boot/grub/grub.cfg; then
            echo "Error: GRUB update failed"
            notify-send "archupdate" "GRUB update failed"
            exit 1
        fi

        # Notify
        notify-send "archupdate" "Finished updating"
        update_statusbar
    else
        echo "Update canceled"
        notify-send "archupdate" "Update canceled by user"
    fi

    echo -e "${GREEN}\nPress enter to exit${RESET}"
    read -r choice
fi

